/**
 * @file setup.ts
 * @description Sistema interactivo de configuraciÃ³n del bot usando embeds y dropdowns.
 * Proporciona una experiencia guiada paso a paso para configurar todos los aspectos del bot.
 * Solo accesible para administradores.
 */

import {
  SlashCommandBuilder,
  PermissionsBitField,
  ActionRowBuilder,
  StringSelectMenuBuilder,
  StringSelectMenuOptionBuilder,
  ButtonBuilder,
  ButtonStyle,
  ComponentType,
} from 'discord.js';
import { upsertGuildConfig, getGuildConfig } from '../config/store';
import { buildEmbed } from '../utils/embed';
import { logger, generateRequestId } from '../utils/logger';

// Estado temporal de la configuraciÃ³n en progreso
const setupSessions = new Map<string, any>();

/** DefiniciÃ³n del comando /setup simplificado */
const data = new SlashCommandBuilder()
  .setName('setup')
  .setDescription('ğŸ› ï¸ ConfiguraciÃ³n interactiva del bot (Sistema guiado paso a paso)');

/**
 * Crea el embed inicial del setup
 */
function createInitialEmbed() {
  return buildEmbed({
    title: 'ğŸ› ï¸ ConfiguraciÃ³n del Bot',
    description:
      'Â¡Bienvenido al asistente de configuraciÃ³n interactivo!\n\n' +
      'Te guiarÃ© paso a paso para configurar todos los aspectos del bot.\n\n' +
      '**Pasos:**\n' +
      '1ï¸âƒ£ Roles (Admin, Junta, VerificaciÃ³n)\n' +
      '2ï¸âƒ£ Canales (Bienvenida, Tickets, Anuncios)\n' +
      '3ï¸âƒ£ Sistema de Voz (VC Create, Pool)\n' +
      '4ï¸âƒ£ Opciones Avanzadas (Alertas, Threshold)\n' +
      '5ï¸âƒ£ ConfirmaciÃ³n Final\n\n' +
      'â±ï¸ Tienes 5 minutos para completar la configuraciÃ³n.',
    color: '#5865F2',
  });
}

/**
 * Crea el embed para el paso 1: Roles
 */
function createRolesEmbed(session: any) {
  const current = session.config;
  return buildEmbed({
    title: '1ï¸âƒ£ ConfiguraciÃ³n de Roles',
    description: 'Selecciona los roles necesarios para el funcionamiento del bot.',
    color: '#5865F2',
    fields: [
      {
        name: 'ğŸ‘‘ Admin',
        value: current.roles.admin ? `<@&${current.roles.admin}>` : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ¯ Junta',
        value: current.roles.junta ? `<@&${current.roles.junta}>` : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'âœ… Verificado (Normal)',
        value: current.roles.verify ? `<@&${current.roles.verify}>` : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ“ Verificado (Javeriana)',
        value: current.roles.verifyJaveriana
          ? `<@&${current.roles.verifyJaveriana}>`
          : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ“¢ Event Ping (Opcional)',
        value: current.roles.eventPing ? `<@&${current.roles.eventPing}>` : 'â­ï¸ Omitir',
        inline: true,
      },
    ],
    footer: 'Usa los menÃºs desplegables para seleccionar cada rol',
  });
}

/**
 * Crea el embed para el paso 2: Canales
 */
function createChannelsEmbed(session: any) {
  const current = session.config;
  return buildEmbed({
    title: '2ï¸âƒ£ ConfiguraciÃ³n de Canales',
    description: 'Selecciona los canales principales del bot.',
    color: '#5865F2',
    fields: [
      {
        name: 'ğŸ‘‹ Bienvenida',
        value: current.channels.welcome ? `<#${current.channels.welcome}>` : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ« Tickets',
        value: current.channels.ticketTrigger
          ? `<#${current.channels.ticketTrigger}>`
          : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ“¢ Anuncios',
        value: current.channels.announcements
          ? `<#${current.channels.announcements}>`
          : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ”” Alertas (Opcional)',
        value: current.channels.alerts ? `<#${current.channels.alerts}>` : 'â­ï¸ Omitir',
        inline: true,
      },
    ],
    footer: 'Usa los menÃºs desplegables para seleccionar cada canal',
  });
}

/**
 * Crea el embed para el paso 3: Sistema de Voz
 */
function createVoiceEmbed(session: any) {
  const current = session.config;
  return buildEmbed({
    title: '3ï¸âƒ£ Sistema de Voz',
    description: 'Configura el sistema Voice Master para canales temporales.',
    color: '#5865F2',
    fields: [
      {
        name: 'ğŸ¤ VC Create',
        value: current.channels.vcCreate ? `<#${current.channels.vcCreate}>` : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ“ CategorÃ­a Voz',
        value: current.channels.voiceCategory
          ? `<#${current.channels.voiceCategory}>`
          : 'âŒ No configurado',
        inline: true,
      },
      {
        name: 'ğŸ”„ VC Pool',
        value:
          current.channels.vcPool?.length > 0
            ? current.channels.vcPool.map((id: string) => `<#${id}>`).join(', ')
            : 'âŒ No configurado',
        inline: false,
      },
    ],
    footer: 'El pool de VCs permite reciclar canales de voz existentes',
  });
}

/**
 * Crea el embed de confirmaciÃ³n final
 */
function createConfirmationEmbed(session: any) {
  const cfg = session.config;
  return buildEmbed({
    title: '5ï¸âƒ£ ConfirmaciÃ³n Final',
    description: 'Â¿Todo estÃ¡ correcto? Revisa la configuraciÃ³n antes de guardar.',
    color: '#5865F2',
    fields: [
      {
        name: 'ğŸ‘‘ Roles',
        value:
          `Admin: ${cfg.roles.admin ? `<@&${cfg.roles.admin}>` : 'âŒ'}\n` +
          `Junta: ${cfg.roles.junta ? `<@&${cfg.roles.junta}>` : 'âŒ'}\n` +
          `Verified: ${cfg.roles.verify ? `<@&${cfg.roles.verify}>` : 'âŒ'}\n` +
          `Javeriana: ${cfg.roles.verifyJaveriana ? `<@&${cfg.roles.verifyJaveriana}>` : 'âŒ'}\n` +
          `Event Ping: ${cfg.roles.eventPing ? `<@&${cfg.roles.eventPing}>` : 'Omitido'}`,
        inline: false,
      },
      {
        name: 'ğŸ“ Canales',
        value:
          `Bienvenida: ${cfg.channels.welcome ? `<#${cfg.channels.welcome}>` : 'âŒ'}\n` +
          `Tickets: ${cfg.channels.ticketTrigger ? `<#${cfg.channels.ticketTrigger}>` : 'âŒ'}\n` +
          `Anuncios: ${cfg.channels.announcements ? `<#${cfg.channels.announcements}>` : 'âŒ'}\n` +
          `Alertas: ${cfg.channels.alerts ? `<#${cfg.channels.alerts}>` : 'Omitido'}`,
        inline: false,
      },
      {
        name: 'ğŸ¤ Sistema de Voz',
        value:
          `VC Create: ${cfg.channels.vcCreate ? `<#${cfg.channels.vcCreate}>` : 'âŒ'}\n` +
          `CategorÃ­a: ${cfg.channels.voiceCategory ? `<#${cfg.channels.voiceCategory}>` : 'âŒ'}\n` +
          `Pool: ${cfg.channels.vcPool?.length > 0 ? `${cfg.channels.vcPool.length} canales` : 'âŒ'}`,
        inline: false,
      },
      {
        name: 'âš™ï¸ Avanzado',
        value: `Threshold Alertas: ${cfg.alertThreshold || 20}%`,
        inline: false,
      },
    ],
    footer: 'âœ… Guardar configuraciÃ³n | âŒ Cancelar',
  });
}
  const config = {
    guildId,
    roles: {
      admin: interaction.options.getString('role_admin', true),
      junta: interaction.options.getString('role_junta', true),
      verify: interaction.options.getString('role_verify', true),
      verifyJaveriana: interaction.options.getString('role_verify_javeriana', true),
      eventPing: interaction.options.getString('role_event_ping') ?? undefined,
    },
    channels: {
      welcome: interaction.options.getString('channel_welcome', true),
      ticketTrigger: interaction.options.getString('channel_ticket', true),
      announcements: interaction.options.getString('channel_announcements', true),
      vcCreate: interaction.options.getString('channel_vc_create', true),
      vcPool: [
        interaction.options.getString('channel_vc1', true),
        interaction.options.getString('channel_vc2', true),
      ],
      voiceCategory: interaction.options.getString('category_voice', true),
      alerts: interaction.options.getString('channel_alerts') ?? undefined,
    },
    alertThreshold: interaction.options.getInteger('alert_threshold') ?? 20,
  };
  upsertGuildConfig(config);
  const embed = buildEmbed({
    title: 'Setup guardado',
    description: 'ConfiguraciÃ³n actualizada para la guild',
    fields: [
      { name: 'Admin', value: `<@&${config.roles.admin}>`, inline: true },
      { name: 'Junta', value: `<@&${config.roles.junta}>`, inline: true },
      { name: 'Verificado (Normal)', value: `<@&${config.roles.verify}>`, inline: true },
      {
        name: 'Verificado (Javeriana)',
        value: `<@&${config.roles.verifyJaveriana}>`,
        inline: true,
      },
      {
        name: 'Rol eventos',
        value: config.roles.eventPing ? `<@&${config.roles.eventPing}>` : 'N/A',
        inline: true,
      },
      { name: 'Welcome', value: `<#${config.channels.welcome}>`, inline: true },
      { name: 'Ticket', value: `<#${config.channels.ticketTrigger}>`, inline: true },
      { name: 'Anuncios', value: `<#${config.channels.announcements}>`, inline: true },
      { name: 'VC Create', value: `<#${config.channels.vcCreate}>`, inline: true },
      {
        name: 'VC Pool',
        value: config.channels.vcPool.map((c) => `<#${c}>`).join(', '),
        inline: false,
      },
      { name: 'CategorÃ­a Voz', value: `<#${config.channels.voiceCategory}>`, inline: true },
      {
        name: 'Canal Alertas',
        value: config.channels.alerts ? `<#${config.channels.alerts}>` : 'No configurado',
        inline: true,
      },
      {
        name: 'Threshold Alertas',
        value: `${config.alertThreshold}%`,
        inline: true,
      },
    ],
  });
  await interaction.reply({ embeds: [embed] });
}

export default { data, execute };
